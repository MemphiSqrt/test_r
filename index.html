<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»£æ­»è€…ç«‹è¨€ (Speaker for the Dead) - V7.1</title>
    <style>
        :root {
            --bg-color: #08080a;
            --panel-bg: #111113;
            --border-color: #333;
            --text-main: #c0c0c0;
            --accent-blue: #4a9eff;
            --accent-gold: #d4af37;
            --accent-red: #ff4a4a;
            --dice-bg: #222;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            margin: 0;
            height: 100vh;
            display: flex;
            overflow: hidden;
            font-size: 14px;
            user-select: none;
        }

        /* === å¸ƒå±€æ¡†æ¶ === */
        #app-container { display: flex; width: 100%; height: 100%; }
        #sidebar-left { width: 250px; background: var(--panel-bg); border-right: 1px solid var(--border-color); padding: 15px; display: flex; flex-direction: column; }
        #main-panel { flex: 1; display: flex; flex-direction: column; background: #000; position: relative; }
        #sidebar-right { width: 300px; background: var(--panel-bg); border-left: 1px solid var(--border-color); padding: 15px; display: flex; flex-direction: column; }

        /* === é¡¶éƒ¨æ  === */
        #top-status-bar {
            height: 60px;
            border-bottom: 1px solid var(--border-color);
            background: #0e0e0e;
            display: flex;
            align-items: center;
            justify-content: space-around;
            font-size: 1.2em;
            font-weight: bold;
        }
        .stat-box { display: flex; align-items: center; gap: 10px; }
        .stat-val { color: #fff; font-family: monospace; }

        /* === å·¦ä¾§ï¼šäººç‰©å¡ç‰‡ === */
        .char-card {
            background: #1a1a1e; border: 1px solid #444; padding: 10px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s;
        }
        .char-card:hover { border-color: var(--accent-blue); background: #222; }
        .char-card.selected { border-color: var(--accent-blue); box-shadow: 0 0 10px rgba(74, 158, 255, 0.1); }
        .char-card.busy { border-color: var(--accent-gold); opacity: 0.8; }
        
        .char-name { font-weight: bold; color: #fff; margin-bottom: 5px; display: flex; justify-content: space-between; }
        .char-status { font-size: 0.8em; color: var(--accent-gold); }
        .char-stats-row { display: flex; gap: 10px; margin-top: 5px; font-size: 0.85em; color: #aaa; }
        
        /* === ä¸­é—´ï¼šäº‹ä»¶æµ === */
        #event-container { padding: 20px; display: flex; gap: 15px; flex-wrap: wrap; overflow-y: auto; align-content: flex-start; flex: 1; }
        .event-card {
            width: 220px; height: 280px; background: #161616; border: 1px solid #444; padding: 15px;
            display: flex; flex-direction: column; position: relative; cursor: pointer; transition: transform 0.2s;
        }
        .event-card:hover { transform: translateY(-2px); border-color: #666; }
        .event-card.active { border-color: var(--accent-blue); box-shadow: 0 0 15px rgba(74, 158, 255, 0.2); }
        .event-card.configured { border-color: var(--accent-gold); }
        
        .event-ttl { position: absolute; top: 10px; right: 10px; color: var(--accent-red); font-size: 0.8em; font-weight: bold; }
        .event-title { font-weight: bold; color: #fff; margin-top: 15px; margin-bottom: 10px; font-size: 1.1em; }
        .event-desc { font-size: 0.9em; color: #999; flex: 1; overflow: hidden; line-height: 1.5; }
        .event-assignee { margin-top: 10px; padding-top: 10px; border-top: 1px dashed #333; color: var(--accent-gold); font-size: 0.9em; }

        /* === å‰§æƒ…å¼¹çª— === */
        #story-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 100;
            display: none; flex-direction: column; justify-content: center; align-items: center;
        }
        .story-box {
            width: 600px; max-height: 80%; background: #111; border: 1px solid var(--accent-blue);
            padding: 40px; box-shadow: 0 0 50px rgba(0,0,0,1); display: flex; flex-direction: column;
        }
        .story-title { font-size: 1.5em; color: var(--accent-blue); margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .story-content { font-size: 1.1em; line-height: 1.8; color: #ddd; margin-bottom: 30px; white-space: pre-wrap; }
        .story-options { display: flex; flex-direction: column; gap: 10px; }
        .story-btn {
            background: #222; border: 1px solid #444; color: #fff; padding: 15px; text-align: left; cursor: pointer; font-size: 1em; transition: all 0.2s;
        }
        .story-btn:hover { border-color: var(--accent-blue); background: #1a1a25; }

        /* åˆ¤å®šç»“æœæ ·å¼ */
        .check-result { margin: 10px 0; padding: 10px; border: 1px solid #444; background: var(--dice-bg); font-family: monospace; }
        .check-success { color: #4aff4a; border-color: #4aff4a; }
        .check-fail { color: #ff4a4a; border-color: #ff4a4a; }

        /* === åº•éƒ¨ä¸å³ä¾§ === */
        #bottom-bar { padding: 20px; background: #0e0e0e; border-top: 1px solid var(--border-color); text-align: right; }
        .next-turn-btn {
            background: var(--accent-gold); color: #000; border: none; padding: 12px 40px;
            font-weight: bold; font-size: 1.1em; cursor: pointer; clip-path: polygon(10px 0, 100% 0, 100% 100%, 0 100%, 0 10px);
        }
        
        .mission-slot, .equip-slot { background: #111; border: 1px solid #444; padding: 15px; margin-bottom: 10px; cursor: pointer; }
        .mission-slot:hover, .equip-slot:hover { border-color: var(--accent-blue); }
        .inv-item { padding: 10px; border-bottom: 1px solid #222; cursor: pointer; display: flex; justify-content: space-between; color: #aaa; }
        .inv-item:hover { color: #fff; background: #1a1a1a; }
        .panel-header { font-size: 1.1em; font-weight: bold; color: #fff; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 5px; }

        #modal-wrapper { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 200; display: none; justify-content: center; align-items: center; }
        #modal-content { background: #1a1a1a; width: 400px; max-height: 600px; padding: 20px; border: 1px solid #555; overflow-y: auto; }
    </style>
</head>
<body>

<div id="app-container">
    <div id="sidebar-left">
        <div class="panel-header">äººå‘˜æ¡£æ¡ˆ</div>
        <div id="char-list" style="flex:1; overflow-y:auto;"></div>
        <div style="margin-top: auto; padding-top: 10px; border-top: 1px solid #333;">
            <div class="mission-slot" style="text-align:center" onclick="Game.viewInventory()">ğŸ“¦ æŸ¥çœ‹ä»“åº“</div>
        </div>
    </div>

    <div id="main-panel">
        <div id="top-status-bar">
            <div class="stat-box">ğŸ“… å¤©æ•°: <span class="stat-val" id="day-val">1</span></div>
            <div class="stat-box">ğŸ’³ é‡‘é’±: <span class="stat-val" id="money-val">0</span></div>
        </div>

        <div id="event-container"></div>
        <div style="flex:1"></div>

        <div id="bottom-bar">
            <button class="next-turn-btn" onclick="Game.nextTurn()">ä¸‹ä¸€å›åˆ â©</button>
        </div>

        <div id="story-overlay">
            <div class="story-box">
                <div class="story-title" id="story-title">æ ‡é¢˜</div>
                <div class="story-content" id="story-text">å†…å®¹</div>
                <div class="story-options" id="story-options"></div>
            </div>
        </div>
    </div>

    <div id="sidebar-right">
        <div id="right-panel-content"></div>
    </div>
</div>

<div id="modal-wrapper" onclick="if(event.target===this) this.style.display='none'">
    <div id="modal-content"></div>
</div>

<script>
// ================================================================================
// â˜…â˜…â˜… data.js (DATA) â˜…â˜…â˜…
// ================================================================================

/* å·¥å…·å‡½æ•°ï¼šåˆ¤å®šç³»ç»Ÿ */
function checkAttribute(charName, attrName, val, threshold) {
    const roll = val > 0 ? Math.floor(Math.random() * val) : 0;
    const success = roll >= threshold;
    const colorClass = success ? 'check-success' : 'check-fail';
    const resultText = success ? 'ã€æˆåŠŸã€‘' : 'ã€å¤±è´¥ã€‘';
    
    const log = `<div class="check-result ${colorClass}">
        [${attrName}åˆ¤å®š] ${charName} (å±æ€§:${val})<br>
        ğŸ² æ·éª°: ${roll} (ç›®æ ‡ >= ${threshold}) -> ${resultText}
    </div>`;
    
    return { success, roll, log };
}

// å¯¹æŠ—åˆ¤å®šï¼švalA vs valB
function contestAttribute(nameA, valA, nameB, valB) {
    const rollA = valA > 0 ? Math.floor(Math.random() * valA) : 0;
    const rollB = valB > 0 ? Math.floor(Math.random() * valB) : 0;
    const userWin = rollA >= rollB;
    
    const colorClass = userWin ? 'check-success' : 'check-fail';
    const resultText = userWin ? `ã€${nameA} èƒœã€‘` : `ã€${nameB} èƒœã€‘`;
    
    const log = `<div class="check-result ${colorClass}">
        [åŠ›é‡å¯¹æŠ—]<br>
        ${nameA}: ğŸ² ${rollA} / ${valA}<br>
        ${nameB}: ğŸ² ${rollB} / ${valB}<br>
        ç»“æœ -> ${resultText}
    </div>`;
    
    return { userWin, rollA, rollB, log };
}

const GameData = {
    initialState: {
        day: 1,
        money: 100,
        flags: {}, // å­˜å‚¨å‰§æƒ… flag
        inventory: ["æ—§æ‰‹æª", "æ•…éšœå¡ï¼šæœªæ¥çš„åºŸå¢Ÿ", "é˜²å¼¹è¡£"] 
    },

    characters: [
        { id: 'x', name: 'å®¡è®¡å®˜ X', role: 'ä¸»è§’', stats: { int: 8, str: 4, sta: 5 }, equipment: { clothes: null, weapon: null, accessory: null } },
        { id: 'y', name: 'åŠ©æ‰‹ Y', role: 'æˆ˜æœ¯æ”¯æ´', stats: { int: 4, str: 5, sta: 2 }, equipment: { clothes: null, weapon: null, accessory: null } }
    ],

    hiddenCharacters: {
        'ghost': { id: 'ghost', name: 'è€é¬¼', role: 'çˆ†ç ´ä¸“å®¶', stats: { int: 3, str: 10, sta: 1 }, equipment: { clothes: null, weapon: 'æœºæ¢°å¼•çˆ†å™¨', accessory: null } }
    },

    itemDefinitions: {
        "é˜²å¼¹è¡£": { slot: "clothes", bonus: "åŠ›+1", desc: "æ ‡å‡†çš„å‡¯å¤«æ‹‰çº¤ç»´è½»å‹æŠ¤ç”²ã€‚" },
        "æ—§æ‰‹æª": { slot: "weapon", bonus: "åŠ›+2", desc: "ä¸€æŠŠç£¨æŸä¸¥é‡çš„åŠè‡ªåŠ¨æ‰‹æªã€‚" },
        "æ•…éšœå¡ï¼šæœªæ¥çš„åºŸå¢Ÿ": { slot: "misc", bonus: "æ— ", desc: "ã€å…³é”®é“å…·ã€‘ä¸€æ®µå­˜å‚¨ç€ä¸å¯é€†ç†µå¢æ•°æ®çš„èŠ¯ç‰‡ã€‚" },
        "æœºæ¢°å¼•çˆ†å™¨": { slot: "weapon", bonus: "åŠ›+5", desc: "ç²—ç³™ï¼Œæ®‹æš´ï¼Œæœ‰æ•ˆçš„æ—§æ—¶ä»£å¼•çˆ†å™¨ã€‚" }
    },

    /* â˜… äº‹ä»¶åº“ (Event Library) â˜… */
    eventLibrary: [
        {
            id: 'daily_report',
            title: 'æ¯æ—¥è¿°èŒ',
            desc: 'å‘ä¸­å¤®AIæäº¤æŠ¥å‘Šã€‚æ—¥å¸¸ä¾‹è¡Œå…¬äº‹ã€‚',
            type: 'daily',
            trigger: () => true, // æ€»æ˜¯è§¦å‘
            logic: {
                assigned: (char, items) => {
                    return { text: `ã€è¿°èŒå®Œæˆã€‘\n${char.name} å®Œæˆäº†ä»Šæ—¥çš„æ±‡æŠ¥ã€‚`, moneyChange: 10 };
                }
            }
        },
        
        // --- å•†åœºå¤§åœç”µ äº‹ä»¶é“¾ ---

        // äº‹ä»¶ 1: åˆå§‹è°ƒæŸ¥
        {
            id: 'mall_blackout_1',
            title: 'å•†åœºå¤§åœç”µ (I)',
            desc: 'AåŒºå‘ç”Ÿçˆ†ç‚¸ã€‚éœ€è¦åœ¨ç°åœºè¿›è¡Œã€æ™ºåŠ›åˆ¤å®šã€‘ä»¥è¿½è¸ªå«Œç–‘äººã€‚',
            type: 'story',
            ttl: 1,
            trigger: (state) => state.day === 1, // ç¬¬ä¸€å¤©è§¦å‘
            logic: {
                assigned: (char, items, state) => {
                    // æ™ºåŠ›åˆ¤å®šï¼Œç›®æ ‡ 3
                    const check = checkAttribute(char.name, 'æ™ºåŠ›', char.stats.int, 3);
                    let resultText = check.log;
                    
                    if (check.success) {
                        state.flags['flag_shopping_mall_0'] = true;
                        resultText += `\nä½ æˆåŠŸåœ¨æ··ä¹±çš„æ•°æ®æµä¸­æ•æ‰åˆ°äº†å¼‚å¸¸ä¿¡å·ï¼Œé”å®šäº†è€é¬¼çš„ä½ç½®ã€‚`;
                    } else {
                        state.flags['flag_shopping_mall_0'] = false;
                        resultText += `\nç°åœºè¿‡äºæ··ä¹±ï¼Œä½ è·Ÿä¸¢äº†ä¿¡å·ã€‚çº¿ç´¢ä¸­æ–­äº†ã€‚`;
                    }
                    
                    return { text: resultText };
                },
                unassigned: (state) => {
                    state.flags['flag_shopping_mall_0'] = false;
                    return { text: "ã€æ— äººå“åº”ã€‘ä½ é”™è¿‡äº†æœ€ä½³è°ƒæŸ¥æ—¶é—´ï¼Œçº¿ç´¢ä¸­æ–­ã€‚", moneyChange: -10, eventOver: true };
                }
            }
        },

        // äº‹ä»¶ 2: æ‰¾åˆ°è€é¬¼ (å‰æ: flag_0 = true)
        {
            id: 'mall_blackout_2',
            title: 'å•†åœºå¤§åœç”µ (II)',
            desc: 'å·²é”å®šè€é¬¼ä½ç½®ã€‚éœ€è¦å†³å®šå¦‚ä½•ä¸ä»–å¯¹å³™ã€‚å»ºè®®æºå¸¦ã€æ•…éšœå¡ã€‘ã€‚',
            type: 'story',
            ttl: 1,
            // è§¦å‘æ¡ä»¶ï¼šå‰ç½®Flagä¸ºçœŸï¼Œä¸”æœ¬äº‹ä»¶æ²¡è§¦å‘è¿‡
            trigger: (state, triggeredIds) => state.flags['flag_shopping_mall_0'] === true && !triggeredIds.includes('mall_blackout_2'),
            logic: {
                assigned: (char, items, state) => {
                    const hasCard = items.includes("æ•…éšœå¡ï¼šæœªæ¥çš„åºŸå¢Ÿ");
                    let text = `ä½ åœ¨åŸºç«™æ ¸å¿ƒæ‰¾åˆ°äº†è€é¬¼ã€‚ä»–æ­£å‡†å¤‡å¼•çˆ†ã€‚\n`;
                    
                    if (hasCard) {
                        state.flags['flag_shopping_mall_1'] = true;
                        text += `ä½ æ‹¿å‡ºäº†ã€æ•…éšœå¡ã€‘ï¼Œå‘ä»–å±•ç¤ºäº†é‚£ä¸ªæ²¡æœ‰å…ƒå®‡å®™çš„åºŸå¢Ÿæœªæ¥ã€‚\nè€é¬¼çš„çœ¼ç¥åŠ¨æ‘‡äº†ã€‚`;
                    } else {
                        state.flags['flag_shopping_mall_1'] = false;
                        text += `ä½ ä¸¤æ‰‹ç©ºç©ºåœ°è¯•å›¾è¯´æœä»–ï¼Œä½†ä»–æ ¹æœ¬å¬ä¸è¿›å»ã€‚\n"ä¼ªå–„è€…ï¼" ä»–æ€’å¼é“ã€‚`;
                    }
                    return { text: text };
                },
                unassigned: (state) => {
                    // æ— äººå¤„ç†ï¼Œè€é¬¼è‡ªçˆ†
                    state.flags['flag_shopping_mall_1'] = false; // è§†ä¸ºè°ˆåˆ¤å¤±è´¥
                    return { text: "ã€è¡ŒåŠ¨å¤±è´¥ã€‘ä½ æ²¡æœ‰å‰å¾€å¯¹å³™ï¼Œè€é¬¼å¼•çˆ†äº†åŸºç«™ã€‚", moneyChange: -50, eventOver: true };
                }
            }
        },

        // ç»“å±€ 1: çœŸç»“å±€ (æ‹›å‹Ÿ)
        {
            id: 'mall_end_1',
            title: 'å¤§åœç”µï¼šæŠ‰æ‹©',
            desc: 'è€é¬¼å·²ç»è¢«çœŸç›¸åŠ¨æ‘‡ã€‚æ˜¯æ—¶å€™åšå‡ºå†³å®šäº†ã€‚',
            type: 'story',
            trigger: (state, triggeredIds) => state.flags['flag_shopping_mall_1'] === true && !triggeredIds.includes('mall_end_1'),
            logic: {
                assigned: (char, items, state) => {
                    return {
                        text: `è€é¬¼æ”¾ä¸‹äº†å¼•çˆ†å™¨ã€‚"å¦‚æœæœªæ¥æ³¨å®šæ˜¯åºŸå¢Ÿï¼Œé‚£æˆ‘å®æ„¿åšé‚£ä¸ªç‚¹ç«çš„äºº...ä½†åœ¨é‚£ä¹‹å‰ï¼Œæˆ‘ä¼šå¸®ä½ ã€‚"`,
                        options: [
                            { text: "ä¼¸å‡ºæ‰‹ (æ‹›å‹Ÿè€é¬¼)", action: "recruit_ghost" }
                        ]
                    };
                }
            }
        },

        // ç»“å±€ 2: åç»“å±€ (çº¿ç´¢ä¸­æ–­)
        {
            id: 'mall_end_2',
            title: 'å¤§åœç”µï¼šè¿·é›¾',
            desc: 'ç”±äºä¹‹å‰çš„è°ƒæŸ¥å¤±è´¥ï¼Œä½ åªèƒ½å¤„ç†å–„åå·¥ä½œã€‚',
            type: 'story',
            // æ³¨æ„ï¼šå› ä¸º mall_1 æ˜¯åœ¨ Day 1 ç»“ç®—æ—¶å‘ç”Ÿï¼Œæ‰€ä»¥ Day 2 å¼€å§‹æ—¶ flag_0 ä¸º falseï¼Œæ­¤äº‹ä»¶è§¦å‘
            trigger: (state, triggeredIds) => state.flags['flag_shopping_mall_0'] === false && !triggeredIds.includes('mall_end_2') && !triggeredIds.includes('mall_end_3'),
            logic: {
                assigned: (char, items, state) => {
                    return { text: `è™½ç„¶åŸºç«™æ²¡æœ‰çˆ†ç‚¸ï¼Œä½†è€é¬¼å·²ç»é€ƒä¹‹å¤­å¤­ã€‚ä½ åªåœ¨ç°åœºæ‰¾åˆ°äº†ä¸€äº›æ— ç”¨çš„é›¶ä»¶ã€‚` };
                },
                unassigned: () => ({ text: "è¿™é‡Œæ²¡ä»€ä¹ˆå¥½åšçš„äº†ã€‚", eventOver: true })
            }
        },

        // ç»“å±€ 3: æƒ¨çƒˆç»“å±€ (åŠ›é‡å¯¹æŠ—)
        {
            id: 'mall_end_3',
            title: 'å¤§åœç”µï¼šæ­»æ–—',
            desc: 'è°ˆåˆ¤ç ´è£‚ã€‚è€é¬¼å‡†å¤‡å¼•çˆ†ï¼Œå¿…é¡»ç«‹åˆ»åˆ¶æ­¢ä»–ï¼(åŠ›é‡å¯¹æŠ—)',
            type: 'story',
            trigger: (state, triggeredIds) => state.flags['flag_shopping_mall_0'] === true && state.flags['flag_shopping_mall_1'] === false && !triggeredIds.includes('mall_end_3'),
            logic: {
                assigned: (char, items, state) => {
                    // åŠ›é‡å¯¹æŠ—ï¼šè§’è‰² vs è€é¬¼(10)
                    const contest = contestAttribute(char.name, char.stats.str, 'è€é¬¼', 10);
                    let resultText = contest.log;

                    if (contest.userWin) {
                        resultText += `\nä½ å†²ä¸Šå»ï¼Œåœ¨å¼•çˆ†å‰ä¸€ç§’æŠ˜æ–­äº†è€é¬¼çš„æ‰‹è…•ã€‚ä»–ç—›è‹¦åœ°å€’åœ¨åœ°ä¸Šï¼Œè¢«éšåèµ¶æ¥çš„ç‰¹è­¦å‡»æ¯™ã€‚`;
                    } else {
                        // ç©å®¶è¾“äº†ï¼šæ‰£å‡åŠ›é‡ï¼Œè€é¬¼è‡ªæ€
                        char.stats.str = Math.max(0, char.stats.str - 1); // æ°¸ä¹…æ‰£å±æ€§
                        resultText += `\nè€é¬¼çš„åŠ›é‡è¶…ä¹æƒ³è±¡ï¼ä»–æŠŠä½ ç”©é£å‡ºå»ï¼ˆåŠ›é‡ -1ï¼‰ã€‚\néšåä»–å¤§ç¬‘ç€å¼•çˆ†äº†èº«ä¸Šçš„æ‰‹é›·ï¼ŒæŠŠè‡ªå·±ç‚¸æˆäº†ç¢ç‰‡ã€‚`;
                    }
                    
                    return { text: resultText };
                },
                unassigned: () => {
                    return { text: "ã€æ‚²å‰§ã€‘æ— äººåˆ¶æ­¢ï¼ŒåŸºç«™è¢«å½»åº•ç‚¸æ¯ã€‚", moneyChange: -100, eventOver: true };
                }
            }
        }
    ]
};

// ================================================================================
// â˜…â˜…â˜… æ¸¸æˆå¼•æ“ (LOGIC) â˜…â˜…â˜…
// ================================================================================

const Game = {
    state: {},
    activeEvents: [], // å½“å‰æ˜¾ç¤ºçš„äº‹ä»¶å¡ç‰‡
    triggeredEventIds: [], // å†å²è§¦å‘è¿‡çš„äº‹ä»¶ID
    storyQueue: [],
    
    selectedCharId: null, 
    activeEventId: null,  
    assignments: {}, 

    init() {
        this.state = JSON.parse(JSON.stringify(GameData.initialState));
        this.state.characters = JSON.parse(JSON.stringify(GameData.characters));
        
        // åˆå§‹æ—¶ä¸åŠ è½½ä»»ä½•äº‹ä»¶ï¼Œé€šè¿‡ updateActiveEvents åŠ¨æ€åŠ è½½
        this.updateActiveEvents();

        if(this.state.characters.length > 0) this.selectedCharId = this.state.characters[0].id;
        this.renderAll();
    },

    // æ ¸å¿ƒï¼šæ¯å›åˆåˆ·æ–°äº‹ä»¶æ± 
    updateActiveEvents() {
        // 1. æ£€æŸ¥åº“ä¸­æ‰€æœ‰äº‹ä»¶
        GameData.eventLibrary.forEach(evtTemplate => {
            // å¦‚æœäº‹ä»¶å·²ç»æ¿€æ´»ä¸”è¿˜åœ¨åˆ—è¡¨ä¸­ï¼Œè·³è¿‡
            if (this.activeEvents.find(e => e.id === evtTemplate.id)) return;
            
            // æ£€æŸ¥è§¦å‘æ¡ä»¶
            if (evtTemplate.trigger && evtTemplate.trigger(this.state, this.triggeredEventIds)) {
                // å®ä¾‹åŒ–äº‹ä»¶ï¼ˆæ·±æ‹·è´ç»“æ„ï¼Œæµ…æ‹·è´å‡½æ•°ï¼‰
                const newEvent = { ...evtTemplate }; 
                this.activeEvents.push(newEvent);
                
                // å¦‚æœæ˜¯å•æ¬¡è§¦å‘çš„å‰§æƒ…äº‹ä»¶ï¼Œè®°å½•IDé˜²æ­¢é‡å¤ï¼ˆé™¤äº†dailyç±»å‹ï¼‰
                if (evtTemplate.type !== 'daily') {
                    this.triggeredEventIds.push(evtTemplate.id);
                }
            }
        });
    },

    nextTurn() {
        this.storyQueue = [];

        // 1. å¤„ç†å½“å‰æ‰€æœ‰æ´»è·ƒäº‹ä»¶
        // å€’åºéå†æ–¹ä¾¿åˆ é™¤
        for (let i = this.activeEvents.length - 1; i >= 0; i--) {
            const event = this.activeEvents[i];
            const assignment = this.assignments[event.id]; 
            
            let result = null;

            if (assignment && assignment.charId) {
                const char = this.state.characters.find(c => c.id === assignment.charId);
                const items = Object.values(char.equipment).filter(x => x); 
                if (assignment.itemId) items.push(assignment.itemId);
                
                if (event.logic && event.logic.assigned) {
                    result = event.logic.assigned(char, items, this.state);
                }
            } else {
                if (event.logic && event.logic.unassigned) {
                    result = event.logic.unassigned(this.state);
                }
            }

            // å¤„ç†ç»“æœ
            if (result) {
                if (result.moneyChange) this.state.money += result.moneyChange;
                
                if (result.text) {
                    this.storyQueue.push({
                        title: event.title,
                        content: result.text,
                        options: result.options || [{ text: "ç¡®å®š", action: "close" }]
                    });
                }

                // æ ‡è®°åˆ é™¤ï¼šå¦‚æœ explicit eventOver æˆ–è€… æ˜¯å·²å¤„ç†çš„å‰§æƒ…äº‹ä»¶
                if (result.eventOver || (event.type === 'story' && assignment && assignment.charId)) {
                   event._shouldDelete = true;
                }
            }

            // TTL é€»è¾‘
            if (event.ttl !== undefined) {
                event.ttl--;
                if (event.ttl < 0) {
                     if (!event._shouldDelete && (!assignment || !assignment.charId)) {
                         this.storyQueue.push({
                             title: event.title,
                             content: "ã€äº‹ä»¶è¿‡æœŸã€‘ä½ é”™å¤±äº†æœºä¼šã€‚",
                             options: [{ text: "ç¡®å®š", action: "close" }]
                         });
                         // å‰§æƒ…è¿‡æœŸé€šå¸¸æ„å‘³ç€æŸç§é»˜è®¤å¤±è´¥ï¼Œè¿™é‡Œä¸ºäº†ç®€åŒ–ï¼Œè®¾ä¸º Flag False
                         if (event.id === 'mall_blackout_1') this.state.flags['flag_shopping_mall_0'] = false;
                     }
                     event._shouldDelete = true;
                }
            }
        }

        // 2. æ¸…ç†è¿‡æœŸäº‹ä»¶
        this.activeEvents = this.activeEvents.filter(e => !e._shouldDelete);
        this.assignments = {}; 
        this.activeEventId = null; 

        // 3. æ¨è¿›å¤©æ•°å¹¶åŠ è½½æ–°äº‹ä»¶
        this.state.day++;
        this.updateActiveEvents();
        
        this.renderAll();
        this.playNextStory();
    },

    // --- å‰§æƒ…æ’­æ”¾ ---
    playNextStory() {
        if (this.storyQueue.length === 0) {
            document.getElementById('story-overlay').style.display = 'none';
            return;
        }

        const story = this.storyQueue.shift();
        const overlay = document.getElementById('story-overlay');
        const titleEl = document.getElementById('story-title');
        const textEl = document.getElementById('story-text');
        const optsEl = document.getElementById('story-options');

        overlay.style.display = 'flex';
        titleEl.innerText = story.title;
        textEl.innerHTML = story.content.replace(/\n/g, '<br>'); // æ”¯æŒæ¢è¡Œ
        optsEl.innerHTML = '';

        story.options.forEach(opt => {
            const btn = document.createElement('div');
            btn.className = 'story-btn';
            btn.innerText = opt.text + " â¤";
            btn.onclick = () => {
                this.handleAction(opt.action);
            };
            optsEl.appendChild(btn);
        });
    },

    handleAction(action) {
        if (action === 'recruit_ghost') {
            const ghostData = JSON.parse(JSON.stringify(GameData.hiddenCharacters['ghost']));
            this.state.characters.push(ghostData);
            this.storyQueue.push({
                title: "æ‹›å‹ŸæˆåŠŸ",
                content: "è€é¬¼å·²åŠ å…¥é˜Ÿä¼ï¼ä»–æ˜¯ä¸ªå±é™©åˆ†å­ï¼Œä½†åœ¨åºŸå¢Ÿä¸­å¾ˆæœ‰ç”¨ã€‚",
                options: [{ text: "ç¡®å®š", action: "close" }]
            });
        }
        // ç»§ç»­æ’­æ”¾
        if (action === 'close') {
             // do nothing, just next
        }
        
        // åˆ·æ–°UIä»¥æ˜¾ç¤ºæ–°é˜Ÿå‹
        this.renderAll();
        
        // ç¨å¾®å»¶è¿Ÿä¸€ç‚¹æ’­æ”¾ä¸‹ä¸€æ¡ï¼Œä½“éªŒæ›´å¥½
        setTimeout(() => this.playNextStory(), 100);
    },

    // --- UI æ¸²æŸ“ä¸äº¤äº’ (è¿™éƒ¨åˆ†ä¿æŒ V6 é€»è¾‘ï¼Œåšå¾®è°ƒ) ---
    viewInventory() { this.selectedCharId = null; this.activeEventId = null; this.renderAll(); },
    
    // æ˜¾ç¤ºç‰©å“è¯¦æƒ…å¼¹çª—
    showItemDetails(itemName) {
        const def = GameData.itemDefinitions[itemName] || { slot: 'misc', bonus: 'æ— ', desc: 'æš‚æ— æè¿°' };
        const modal = document.getElementById('modal-wrapper');
        const content = document.getElementById('modal-content');
        
        modal.style.display = 'flex';
        
        const slotNames = { 'clothes': 'ğŸ‘” æœè£…', 'weapon': 'ğŸ”« æ­¦å™¨', 'accessory': 'ğŸ’ é¥°å“', 'misc': 'ğŸ“¦ æ‚ç‰©' };
        const slotName = slotNames[def.slot] || def.slot;

        content.innerHTML = `
            <h3 style="color:var(--accent-blue); border-bottom:1px solid #333; padding-bottom:10px;">${itemName}</h3>
            <div style="color:#888; font-size:0.9em; margin-top:10px;">ç‰©å“æè¿°</div>
            <div style="color:#fff; margin-bottom:5px; line-height:1.6;">${def.desc || "æš‚æ— æè¿°"}</div>
            
            <div style="display:flex; gap:20px; margin-top:20px; padding-top:10px; border-top:1px dashed #333">
                <div>
                    <div style="color:#888; font-size:0.9em;">è£…å¤‡éƒ¨ä½</div>
                    <div style="color:#fff;">${slotName}</div>
                </div>
                <div>
                    <div style="color:#888; font-size:0.9em;">å±æ€§åŠ æˆ</div>
                    <div style="color:var(--accent-gold); font-weight:bold;">${def.bonus}</div>
                </div>
            </div>
            
             <div class="inv-item" style="margin-top:20px; text-align:center; color:#ddd; border:1px solid #444;" onclick="document.getElementById('modal-wrapper').style.display='none'">å…³é—­</div>
        `;
    },
    
    selectChar(charId) { this.selectedCharId = charId; this.activeEventId = null; this.renderAll(); },
    
    selectEvent(eventId) { 
        this.activeEventId = eventId; 
        if (!this.assignments[eventId]) this.assignments[eventId] = { charId: null, itemId: null };
        this.renderAll();
    },

    assignCharToActiveEvent() {
        if (!this.activeEventId) return;
        this.openModal('é€‰æ‹©æ‰§è¡Œå¹²å‘˜', this.state.characters.map(c => {
            let isBusy = false;
            for(let eid in this.assignments) if(eid !== this.activeEventId && this.assignments[eid].charId === c.id) isBusy = true;
            return {
                text: c.name + (isBusy?" (å¿™ç¢Œ)":""),
                disabled: isBusy,
                onClick: () => { this.assignments[this.activeEventId].charId = c.id; this.closeModal(); this.renderAll(); }
            };
        }), true); // true for adding a cancel button
    },

    assignItemToActiveEvent() {
        if (!this.activeEventId) return;
        this.openModal('é€‰æ‹©æºå¸¦ç‰©å“', [
            ...this.state.inventory.map(i => ({ text: i, onClick: () => { this.assignments[this.activeEventId].itemId = i; this.closeModal(); this.renderAll(); } })),
            { text: "[ä¸æºå¸¦]", onClick: () => { this.assignments[this.activeEventId].itemId = null; this.closeModal(); this.renderAll(); }, color: '#aaa' }
        ]);
    },

    toggleEquip(slotName) {
        if (!this.selectedCharId) return;
        const char = this.state.characters.find(c => c.id === this.selectedCharId);
        const currentItem = char.equipment[slotName];

        const options = [];
        if (currentItem) {
            options.push({ text: `[å¸ä¸‹] ${currentItem}`, color: '#ff4a4a', onClick: () => { this.state.inventory.push(currentItem); char.equipment[slotName] = null; this.closeModal(); this.renderAll(); } });
        }
        
        this.state.inventory.forEach((item, idx) => {
            const def = GameData.itemDefinitions[item] || { slot: 'misc' };
            if (def.slot === slotName) {
                options.push({ text: item + ` (${def.bonus})`, onClick: () => {
                    if (char.equipment[slotName]) this.state.inventory.push(char.equipment[slotName]);
                    char.equipment[slotName] = item;
                    this.state.inventory.splice(idx, 1);
                    this.closeModal(); this.renderAll();
                }});
            }
        });

        this.openModal(`æ›´æ¢ ${slotName}`, options);
    },

    // ç»Ÿä¸€æ¨¡æ€æ¡†å·¥å…·
    openModal(title, items, hasWithdraw = false) {
        const modal = document.getElementById('modal-wrapper');
        const content = document.getElementById('modal-content');
        modal.style.display = 'flex';
        content.innerHTML = `<h3 style="color:var(--accent-blue)">${title}</h3>`;
        
        items.forEach(item => {
            const div = document.createElement('div');
            div.className = 'inv-item';
            div.style.color = item.color || (item.disabled ? '#555' : '#fff');
            div.innerText = item.text;
            if(!item.disabled) div.onclick = item.onClick;
            content.appendChild(div);
        });

        if(hasWithdraw) {
            const div = document.createElement('div');
            div.className = 'inv-item';
            div.style.color = '#ff4a4a';
            div.innerText = "[æ’¤å›æŒ‡æ´¾]";
            div.onclick = () => { this.assignments[this.activeEventId].charId = null; this.closeModal(); this.renderAll(); };
            content.appendChild(div);
        }
    },
    closeModal() { document.getElementById('modal-wrapper').style.display = 'none'; },

    renderAll() {
        document.getElementById('day-val').innerText = this.state.day;
        document.getElementById('money-val').innerText = this.state.money;

        // 1. å·¦ä¾§ï¼šäººç‰©
        const charContainer = document.getElementById('char-list');
        charContainer.innerHTML = '';
        this.state.characters.forEach(char => {
            let isBusy = false;
            let busyTitle = "";
            for(let eid in this.assignments) if(this.assignments[eid].charId === char.id) { isBusy=true; busyTitle = this.activeEvents.find(e=>e.id===eid)?.title; }

            const div = document.createElement('div');
            div.className = `char-card ${this.selectedCharId === char.id ? 'selected' : ''} ${isBusy ? 'busy' : ''}`;
            div.onclick = () => this.selectChar(char.id);
            
            // è®¡ç®—åŠ æˆ
            let bonusStr = 0, bonusInt = 0;
            Object.values(char.equipment).forEach(i => {
                const def = GameData.itemDefinitions[i];
                if(def && def.bonus) {
                    if(def.bonus.includes('åŠ›')) bonusStr += parseInt(def.bonus.split('+')[1]||0);
                    if(def.bonus.includes('æ™º')) bonusInt += parseInt(def.bonus.split('+')[1]||0);
                }
            });

            div.innerHTML = `
                <div class="char-name">${char.name} <span class="stat-badge">${char.role}</span></div>
                <div class="char-status" style="color:${isBusy?'var(--accent-gold)':'#666'}">${isBusy ? 'â¤ ' + busyTitle : 'å¾…å‘½'}</div>
                <div class="char-stats-row">
                    <span style="${bonusInt>0?'color:#4a9eff':''}">æ™º:${char.stats.int + bonusInt}</span>
                    <span style="${bonusStr>0?'color:#4a9eff':''}">åŠ›:${char.stats.str + bonusStr}</span>
                    <span>åŠ¿:${char.stats.sta}</span>
                </div>
            `;
            charContainer.appendChild(div);
        });

        // 2. ä¸­é—´ï¼šäº‹ä»¶
        const eventContainer = document.getElementById('event-container');
        eventContainer.innerHTML = '';
        this.activeEvents.forEach(e => {
            const assignment = this.assignments[e.id];
            const hasChar = assignment && assignment.charId;
            const assigneeName = hasChar ? this.state.characters.find(c=>c.id===assignment.charId).name : '';
            
            const div = document.createElement('div');
            div.className = `event-card ${this.activeEventId === e.id ? 'active' : ''} ${hasChar ? 'configured' : ''}`;
            div.onclick = () => this.selectEvent(e.id);
            
            const ttlHtml = e.ttl !== undefined ? `<div class="event-ttl">â³ å‰© ${e.ttl} å¤©</div>` : '';
            div.innerHTML = `
                ${ttlHtml}
                <div style="font-size:0.8em; color:#666; text-transform:uppercase">${e.type}</div>
                <div class="event-title">${e.title}</div>
                <div class="event-desc">${e.desc}</div>
                ${hasChar ? `<div class="event-assignee">â¤ å·²æŒ‡æ´¾: ${assigneeName}</div>` : ''}
            `;
            eventContainer.appendChild(div);
        });

        // 3. å³ä¾§ï¼šä¸Šä¸‹æ–‡
        const rightContainer = document.getElementById('right-panel-content');
        rightContainer.innerHTML = '';
        
        if (this.activeEventId) {
            const event = this.activeEvents.find(e => e.id === this.activeEventId);
            const assignment = this.assignments[this.activeEventId];
            if(event) {
                const charName = assignment.charId ? this.state.characters.find(c => c.id === assignment.charId).name : 'ç‚¹å‡»é€‰æ‹©äººå‘˜';
                const itemName = assignment.itemId ? assignment.itemId : 'ç‚¹å‡»é€‰æ‹©ç‰©å“';
                
                rightContainer.innerHTML = `<div class="panel-header">æŒ‡æ´¾: ${event.title}</div>`;
                
                const charSlot = document.createElement('div');
                charSlot.className = 'mission-slot';
                charSlot.onclick = () => this.assignCharToActiveEvent();
                charSlot.innerHTML = `<span class="slot-title">æ‰§è¡Œå¹²å‘˜</span><span class="slot-content" style="${!assignment.charId?'color:#444;font-style:italic':''}">${charName}</span>`;
                rightContainer.appendChild(charSlot);

                const itemSlot = document.createElement('div');
                itemSlot.className = 'mission-slot';
                itemSlot.onclick = () => this.assignItemToActiveEvent();
                itemSlot.innerHTML = `<span class="slot-title">æºå¸¦ç‰©å“</span><span class="slot-content" style="${!assignment.itemId?'color:#444;font-style:italic':''}">${itemName}</span>`;
                rightContainer.appendChild(itemSlot);
                
                const desc = document.createElement('div');
                desc.style.padding='10px'; desc.style.color='#888'; desc.style.fontSize='0.9em';
                desc.innerText = event.desc;
                rightContainer.appendChild(desc);
            }
        } else if (this.selectedCharId) {
            const char = this.state.characters.find(c => c.id === this.selectedCharId);
            rightContainer.innerHTML = `<div class="panel-header">è£…å¤‡: ${char.name}</div>`;
            const slots = [{k:'clothes',n:'ğŸ‘” æœè£…'}, {k:'weapon',n:'ğŸ”« æ­¦å™¨'}, {k:'accessory',n:'ğŸ’ é¥°å“'}];
            slots.forEach(s => {
                const item = char.equipment[s.k];
                const def = item ? GameData.itemDefinitions[item] : null;
                const div = document.createElement('div');
                div.className = 'equip-slot';
                div.onclick = () => this.toggleEquip(s.k);
                div.innerHTML = `<span class="slot-label">${s.n}</span><span class="slot-val" style="${!item?'color:#444;font-weight:normal':''}">${item ? item + (def?.bonus ? ` (${def.bonus})` : '') : 'ç©º'}</span>`;
                rightContainer.appendChild(div);
            });
        } else {
            rightContainer.innerHTML = `<div class="panel-header">ä»“åº“åˆ—è¡¨ (ç‚¹å‡»è¯¦æƒ…)</div>`;
            this.state.inventory.forEach(i => {
                const div = document.createElement('div');
                div.className = 'inv-item';
                div.innerText = i;
                div.onclick = () => Game.showItemDetails(i); // ä½¿ç”¨æ–°åŠ çš„å‡½æ•°
                rightContainer.appendChild(div);
            });
        }
    }
};

Game.init();
</script>
</body>
</html>
