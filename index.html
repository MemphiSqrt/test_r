<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»£æ­»è€…ç«‹è¨€ (Speaker for the Dead) - V5</title>
    <style>
        :root {
            --bg-color: #08080a;
            --panel-bg: #111113;
            --border-color: #333;
            --text-main: #c0c0c0;
            --accent-blue: #4a9eff;
            --accent-gold: #d4af37;
            --accent-red: #ff4a4a;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            margin: 0;
            height: 100vh;
            display: flex;
            overflow: hidden;
            font-size: 14px;
            user-select: none;
        }

        /* === å¸ƒå±€æ¡†æ¶ === */
        #app-container { display: flex; width: 100%; height: 100%; }
        #sidebar-left { width: 250px; background: var(--panel-bg); border-right: 1px solid var(--border-color); padding: 15px; display: flex; flex-direction: column; }
        #main-panel { flex: 1; display: flex; flex-direction: column; background: #000; position: relative; }
        #sidebar-right { width: 300px; background: var(--panel-bg); border-left: 1px solid var(--border-color); padding: 15px; display: flex; flex-direction: column; }

        /* === é¡¶éƒ¨æ  === */
        #top-status-bar {
            height: 60px;
            border-bottom: 1px solid var(--border-color);
            background: #0e0e0e;
            display: flex;
            align-items: center;
            justify-content: space-around;
            font-size: 1.2em;
            font-weight: bold;
        }
        .stat-box { display: flex; align-items: center; gap: 10px; }
        .stat-val { color: #fff; font-family: monospace; }

        /* === å·¦ä¾§ï¼šäººç‰©å¡ç‰‡ === */
        .char-card {
            background: #1a1a1e; border: 1px solid #444; padding: 10px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s;
        }
        .char-card:hover { border-color: var(--accent-blue); background: #222; }
        .char-card.selected { border-color: var(--accent-blue); box-shadow: 0 0 10px rgba(74, 158, 255, 0.1); }
        .char-card.busy { border-color: var(--accent-gold); opacity: 0.8; }
        
        .char-name { font-weight: bold; color: #fff; margin-bottom: 5px; display: flex; justify-content: space-between; }
        .char-status { font-size: 0.8em; color: var(--accent-gold); }
        .char-stats-row { display: flex; gap: 10px; margin-top: 5px; font-size: 0.85em; color: #aaa; }
        .stat-badge { background: #333; padding: 2px 4px; border-radius: 3px; }

        /* å·¦ä¾§åº•éƒ¨æŒ‰é’® */
        .sidebar-btn {
            background: #1f1f25; border: 1px solid #444; color: #ddd; padding: 12px; 
            width: 100%; cursor: pointer; text-align: center; transition: all 0.2s; font-weight: bold;
            margin-top: 10px;
        }
        .sidebar-btn:hover { background: #333; border-color: var(--accent-blue); color: #fff; }

        /* === ä¸­é—´ï¼šäº‹ä»¶æµ === */
        #event-container { padding: 20px; display: flex; gap: 15px; flex-wrap: wrap; overflow-y: auto; align-content: flex-start; flex: 1; }
        .event-card {
            width: 200px; height: 260px; background: #161616; border: 1px solid #444; padding: 15px;
            display: flex; flex-direction: column; position: relative; cursor: pointer; transition: transform 0.2s;
        }
        .event-card:hover { transform: translateY(-2px); border-color: #666; }
        .event-card.active { border-color: var(--accent-blue); box-shadow: 0 0 15px rgba(74, 158, 255, 0.2); }
        .event-card.configured { border-color: var(--accent-gold); }
        
        .event-ttl { position: absolute; top: 10px; right: 10px; color: var(--accent-red); font-size: 0.8em; font-weight: bold; }
        .event-title { font-weight: bold; color: #fff; margin-top: 15px; margin-bottom: 10px; font-size: 1.1em; }
        .event-desc { font-size: 0.9em; color: #999; flex: 1; overflow: hidden; line-height: 1.5; }
        .event-assignee { margin-top: 10px; padding-top: 10px; border-top: 1px dashed #333; color: var(--accent-gold); font-size: 0.9em; }

        /* === å‰§æƒ…å¼¹çª— (è¦†ç›–å±‚) === */
        #story-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 100;
            display: none; flex-direction: column; justify-content: center; align-items: center;
        }
        .story-box {
            width: 600px; max-height: 80%; background: #111; border: 1px solid var(--accent-blue);
            padding: 40px; box-shadow: 0 0 50px rgba(0,0,0,1); display: flex; flex-direction: column;
        }
        .story-title { font-size: 1.5em; color: var(--accent-blue); margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .story-content { font-size: 1.1em; line-height: 1.8; color: #ddd; margin-bottom: 30px; white-space: pre-wrap; }
        .story-options { display: flex; flex-direction: column; gap: 10px; }
        .story-btn {
            background: #222; border: 1px solid #444; color: #fff; padding: 15px; text-align: left; cursor: pointer; font-size: 1em; transition: all 0.2s;
        }
        .story-btn:hover { border-color: var(--accent-blue); background: #1a1a25; }

        /* === åº•éƒ¨æŒ‰é’® === */
        #bottom-bar { padding: 20px; background: #0e0e0e; border-top: 1px solid var(--border-color); text-align: right; }
        .next-turn-btn {
            background: var(--accent-gold); color: #000; border: none; padding: 12px 40px;
            font-weight: bold; font-size: 1.1em; cursor: pointer; clip-path: polygon(10px 0, 100% 0, 100% 100%, 0 100%, 0 10px);
        }
        .next-turn-btn:hover { background: #ffd700; }

        /* === å³ä¾§ï¼šä»»åŠ¡æŒ‡æ´¾ä¸è£…å¤‡ === */
        .panel-header { font-size: 1.1em; font-weight: bold; color: #fff; margin-bottom: 15px; padding-bottom: 5px; border-bottom: 1px solid #333; }
        
        .mission-slot {
            background: #111; border: 1px solid #444; padding: 15px; margin-bottom: 15px;
            cursor: pointer; text-align: center; transition: all 0.2s;
        }
        .mission-slot:hover { border-color: var(--accent-blue); background: #161620; }
        .slot-title { display: block; color: #666; font-size: 0.8em; margin-bottom: 5px; }
        .slot-content { font-size: 1.1em; color: var(--accent-gold); font-weight: bold; }
        .slot-empty { color: #444; font-style: italic; }

        .equip-slot {
            background: #161616; border: 1px dashed #444; padding: 12px; margin-bottom: 10px;
            display: flex; justify-content: space-between; align-items: center; cursor: pointer;
        }
        .equip-slot:hover { border-color: #777; background: #1a1a1a; }
        .slot-label { color: #666; font-size: 0.8em; }
        .slot-val { color: var(--accent-blue); font-weight: bold; }
        
        .inv-item { padding: 10px; border-bottom: 1px solid #222; cursor: pointer; display: flex; justify-content: space-between; color: #aaa; }
        .inv-item:hover { color: #fff; background: #1a1a1a; }
        .inv-special { color: var(--accent-gold); }

        /* é€šç”¨æ¨¡æ€æ¡† */
        #modal-wrapper {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8);
            z-index: 200; display: none; justify-content: center; align-items: center;
        }
        #modal-content { background: #1a1a1a; width: 400px; max-height: 600px; padding: 20px; border: 1px solid #555; overflow-y: auto; }
        
        /* ç‰©å“è¯¦æƒ…æ ·å¼ */
        .item-detail-label { color: #888; font-size: 0.9em; margin-top: 10px; }
        .item-detail-val { color: #fff; margin-bottom: 5px; }
    </style>
</head>
<body>

<div id="app-container">
    <!-- å·¦æ ï¼šäººç‰© -->
    <div id="sidebar-left">
        <div class="panel-header">äººå‘˜æ¡£æ¡ˆ</div>
        <div id="char-list" style="flex:1; overflow-y:auto;"></div>
        
        <!-- æ–°å¢ï¼šæŸ¥çœ‹ä»“åº“æŒ‰é’® -->
        <div style="margin-top: auto; padding-top: 10px; border-top: 1px solid #333;">
            <button class="sidebar-btn" onclick="Game.viewInventory()">ğŸ“¦ æŸ¥çœ‹ä»“åº“ç‰©å“</button>
        </div>
    </div>

    <!-- ä¸­é—´ï¼šä¸»ç•Œé¢ -->
    <div id="main-panel">
        <div id="top-status-bar">
            <div class="stat-box">ğŸ“… å¤©æ•°: <span class="stat-val" id="day-val">1</span></div>
            <div class="stat-box">ğŸ’³ é‡‘é’±: <span class="stat-val" id="money-val">0</span></div>
        </div>

        <div id="event-container">
            <!-- äº‹ä»¶å¡ç‰‡ç”ŸæˆåŒº -->
        </div>
        <div style="flex:1"></div> <!-- å ä½ -->

        <div id="bottom-bar">
            <button class="next-turn-btn" onclick="Game.nextTurn()">ä¸‹ä¸€å›åˆ â©</button>
        </div>

        <!-- å‰§æƒ…å¼¹çª— -->
        <div id="story-overlay">
            <div class="story-box">
                <div class="story-title" id="story-title">æ ‡é¢˜</div>
                <div class="story-content" id="story-text">å†…å®¹</div>
                <div class="story-options" id="story-options"></div>
            </div>
        </div>
    </div>

    <!-- å³æ ï¼šä¸Šä¸‹æ–‡é¢æ¿ -->
    <div id="sidebar-right">
        <div id="right-panel-content">
            <!-- åŠ¨æ€å†…å®¹ -->
        </div>
    </div>
</div>

<!-- é€‰æ‹©å™¨/è¯¦æƒ… æ¨¡æ€æ¡† -->
<div id="modal-wrapper" onclick="if(event.target===this) this.style.display='none'">
    <div id="modal-content" id="selector-list"></div>
</div>

<script>
/* ================================================================================
   â˜… ç”¨æˆ·é…ç½®åŒº (USER CONFIGURATION) â˜…
   ================================================================================
*/

const GameData = {
    // 1. åˆå§‹å…¨å±€çŠ¶æ€
    initialState: {
        day: 1,
        money: 100,
        inventory: ["åˆæˆå’–å•¡", "æ—§æ‰‹æª", "æ•…éšœå¡ï¼šæœªæ¥çš„åºŸå¢Ÿ", "é˜²å¼¹è¡£"] 
    },

    // 2. åˆå§‹é˜Ÿä¼
    characters: [
        { 
            id: 'x', name: 'å®¡è®¡å®˜ X', role: 'ä¸»è§’', 
            stats: { int: 8, str: 4, sta: 5 },
            equipment: { clothes: null, weapon: null, accessory: null } 
        },
        { 
            id: 'y', name: 'åŠ©æ‰‹ Y', role: 'æˆ˜æœ¯æ”¯æ´', 
            stats: { int: 4, str: 5, sta: 2 },
            equipment: { clothes: null, weapon: null, accessory: null } 
        }
    ],

    // 3. éšè—è§’è‰²
    hiddenCharacters: {
        'ghost': { 
            id: 'ghost', name: 'è€é¬¼', role: 'çˆ†ç ´ä¸“å®¶', 
            stats: { int: 3, str: 10, sta: 1 },
            equipment: { clothes: null, weapon: 'æœºæ¢°å¼•çˆ†å™¨', accessory: null }
        }
    },

    // 4. ç‰©å“å®šä¹‰ (æ–°å¢ desc å­—æ®µ)
    itemDefinitions: {
        "é˜²å¼¹è¡£": { 
            slot: "clothes", bonus: "åŠ›+1", 
            desc: "æ ‡å‡†çš„å‡¯å¤«æ‹‰çº¤ç»´è½»å‹æŠ¤ç”²ï¼Œè™½ç„¶æŒ¡ä¸ä½é«˜èƒ½ç²’å­æŸï¼Œä½†å¯¹ä»˜æµå¼¹ç»°ç»°æœ‰ä½™ã€‚" 
        },
        "æ—§æ‰‹æª": { 
            slot: "weapon", bonus: "åŠ›+2", 
            desc: "ä¸€æŠŠç£¨æŸä¸¥é‡çš„åŠè‡ªåŠ¨æ‰‹æªã€‚æ¡æŠŠä¸Šçš„ç¼–å·å·²ç»è¢«é”‰æ‰äº†ã€‚å¯é æ€§æˆç–‘ï¼Œä½†æ€»æ¯”æ‹³å¤´å¥½ã€‚" 
        },
        "æ•…éšœå¡ï¼šæœªæ¥çš„åºŸå¢Ÿ": { 
            slot: "accessory", bonus: "æ™º+3", 
            desc: "ã€å…³é”®é“å…·ã€‘ä¸€æ®µå­˜å‚¨ç€ä¸å¯é€†ç†µå¢æ•°æ®çš„èŠ¯ç‰‡ã€‚ä»…ä»…æ˜¯æ³¨è§†ç€å®ƒï¼Œå°±èƒ½è®©äººæ„Ÿå—åˆ°æ–‡æ˜ç†„ç­åçš„æ­»å¯‚ã€‚å¯ä»¥ç”¨æ¥åŠ¨æ‘‡ä¿¡ä»°ã€‚" 
        },
        "åˆæˆå’–å•¡": { 
            slot: "misc", bonus: "æ— ", 
            desc: "ç”±å·¥ä¸šåºŸæ¸£å›æ”¶å†åˆ©ç”¨åˆ¶æˆçš„é»‘è‰²æ¶²ä½“ã€‚å‘³é“åƒçƒ§ç„¦çš„è½®èƒï¼Œä½†å’–å•¡å› æ˜¯çœŸçš„ã€‚" 
        },
        "æœºæ¢°å¼•çˆ†å™¨": { 
            slot: "weapon", bonus: "åŠ›+5", 
            desc: "æ—§æ—¶ä»£çš„äº§ç‰©ï¼Œæ²¡æœ‰ç”µå­ä¿¡å·ï¼Œæ— æ³•è¢«é»‘å®¢å…¥ä¾µã€‚ç²—ç³™ï¼Œæ®‹æš´ï¼Œæœ‰æ•ˆã€‚" 
        }
    },

    // 5. äº‹ä»¶åº“
    events: [
        {
            id: 'daily_report',
            title: 'æ¯æ—¥è¿°èŒ',
            desc: 'å‘ä¸­å¤®AIæäº¤æŠ¥å‘Šã€‚æ— ç‰¹æ®Šæƒ…å†µä¸éœ€æˆ˜æ–—ã€‚',
            type: 'daily',
            logic: {
                assigned: (char, items) => {
                    return {
                        text: `ã€è¿°èŒå®Œæˆã€‘\n${char.name} å‰å¾€äº†ä¸Šå±‚åŒºè¿›è¡Œè¿°èŒã€‚\nè™½ç„¶è¿‡ç¨‹æ¯ç‡¥ï¼Œä½†è–ªæ°´ç…§å‘ã€‚`,
                        moneyChange: 10
                    };
                },
                unassigned: () => null 
            }
        },
        {
            id: 'mall_blackout',
            title: 'å•†åœºå¤§åœç”µ',
            desc: 'AåŒºå‘ç”Ÿçˆ†ç‚¸ã€‚è€é¬¼æ­£å¨èƒè¦ç‚¸æ¯åŸºç«™ã€‚',
            type: 'story',
            ttl: 1, 
            logic: {
                assigned: (char, items) => {
                    const hasGlitchCard = items.includes("æ•…éšœå¡ï¼šæœªæ¥çš„åºŸå¢Ÿ");
                    
                    if (hasGlitchCard) {
                        return {
                            text: `ã€æ¥è§¦ï¼šè€é¬¼ã€‘\n${char.name} åœ¨çƒŸé›¾ä¸­æ‰¾åˆ°äº†è€é¬¼ã€‚\n\né¢å¯¹å¼•çˆ†å™¨ï¼Œä½ æ‹¿å‡ºäº†ã€æ•…éšœå¡ã€‘ï¼Œå±•ç¤ºäº†æœªæ¥çš„æ¯ç­æ™¯è±¡ã€‚\nè€é¬¼çœ‹ç€é‚£ä¸ªæ²¡æœ‰å…ƒå®‡å®™çš„åºŸå¢Ÿæœªæ¥ï¼Œé™·å…¥äº†æ²‰é»˜ã€‚`,
                            options: [
                                { text: "é‚€è¯·ä»–åŠ å…¥ (çœŸç»“å±€)", action: "recruit_ghost" }
                            ]
                        };
                    } else {
                        return {
                            text: `ã€æ¥è§¦ï¼šè€é¬¼ã€‘\n${char.name} è¯•å›¾æ¥è¿‘è€é¬¼ï¼Œä½†ä»–æå…¶è­¦è§‰ã€‚\næ²¡æœ‰è¶³å¤Ÿæœ‰åŠ›çš„è¯æ®åŠ¨æ‘‡ä»–çš„ä¿¡å¿µï¼Œè°ˆåˆ¤ç ´è£‚äº†ã€‚`,
                            options: [
                                { text: "å¼ºè¡Œå‡»æ¯™ (è·å¾—èµé‡‘)", action: "kill_ghost" },
                                { text: "æ’¤é€€ (å¤±è´¥)", action: "retreat" }
                            ]
                        };
                    }
                },
                unassigned: () => {
                    return {
                        text: `ã€æ‚²æŠ¥ï¼šAåŒºåŸºç«™æŸæ¯ã€‘\nå› ä¸ºæ— äººå“åº”è­¦æŠ¥ï¼Œè€é¬¼å¼•çˆ†äº†ç‚¸å¼¹ã€‚\næ•°ç™¾äººçš„ä¸Šä¼ æ•°æ®ä¸¢å¤±ã€‚\nå®‰å…¨å±€æ‰£é™¤äº†ä½ çš„èµ„é‡‘ä½œä¸ºæƒ©ç½šã€‚`,
                        moneyChange: -50,
                        eventOver: true
                    };
                }
            }
        }
    ]
};

/* ================================================================================
   â˜… æ¸¸æˆå¼•æ“ (GAME ENGINE) â˜…
   ================================================================================
*/

const Game = {
    state: {},
    activeEvents: [],
    storyQueue: [],
    
    selectedCharId: null, 
    activeEventId: null,  
    assignments: {}, 

    init() {
        this.state = JSON.parse(JSON.stringify(GameData.initialState));
        this.state.characters = JSON.parse(JSON.stringify(GameData.characters));
        
        // â˜…â˜…â˜… ä¿®å¤ç‚¹ï¼šä½¿ç”¨æµ…æ‹·è´è€Œä¸æ˜¯ JSON åºåˆ—åŒ–ï¼Œä»¥ä¿ç•™ logic å‡½æ•° â˜…â˜…â˜…
        this.activeEvents = GameData.events.map(e => ({...e}));
        
        if(this.state.characters.length > 0) {
            this.selectedCharId = this.state.characters[0].id;
        }

        this.renderAll();
    },

    nextTurn() {
        this.state.day++;
        this.storyQueue = [];

        for (let i = this.activeEvents.length - 1; i >= 0; i--) {
            const event = this.activeEvents[i];
            const assignment = this.assignments[event.id]; 
            
            let result = null;

            if (assignment && assignment.charId) {
                const char = this.state.characters.find(c => c.id === assignment.charId);
                const items = Object.values(char.equipment).filter(x => x); 
                if (assignment.itemId) items.push(assignment.itemId);
                
                // æ‰§è¡Œé€»è¾‘ï¼ˆç°åœ¨è¿™é‡Œä¸ä¼šæ˜¯ undefined äº†ï¼‰
                if (event.logic && event.logic.assigned) {
                    result = event.logic.assigned(char, items);
                }
            } else {
                if (event.logic && event.logic.unassigned) {
                    result = event.logic.unassigned();
                }
            }

            if (result) {
                if (result.moneyChange) this.state.money += result.moneyChange;
                
                this.storyQueue.push({
                    title: event.title,
                    content: result.text,
                    options: result.options || [{ text: "ç¡®å®š", action: "close" }]
                });

                if (result.eventOver || (event.type === 'story' && assignment && assignment.charId)) {
                   event._shouldDelete = true;
                }
            }

            if (event.ttl !== undefined) {
                event.ttl--;
                if (event.ttl < 0) {
                     if (!event._shouldDelete && (!assignment || !assignment.charId)) {
                         this.storyQueue.push({
                             title: event.title,
                             content: "ã€äº‹ä»¶è¿‡æœŸã€‘è¯¥äº‹ä»¶å·²å¤±æ•ˆï¼Œæœºä¼šæ¶ˆå¤±äº†ã€‚",
                             options: [{ text: "ç¡®å®š", action: "close" }]
                         });
                     }
                     event._shouldDelete = true;
                }
            }
        }

        this.activeEvents = this.activeEvents.filter(e => !e._shouldDelete);
        this.assignments = {}; 
        this.activeEventId = null; 
        
        this.renderAll();
        this.playNextStory();
    },

    playNextStory() {
        if (this.storyQueue.length === 0) {
            document.getElementById('story-overlay').style.display = 'none';
            return;
        }

        const story = this.storyQueue.shift();
        const overlay = document.getElementById('story-overlay');
        const titleEl = document.getElementById('story-title');
        const textEl = document.getElementById('story-text');
        const optsEl = document.getElementById('story-options');

        overlay.style.display = 'flex';
        titleEl.innerText = story.title;
        textEl.innerText = story.content;
        optsEl.innerHTML = '';

        story.options.forEach(opt => {
            const btn = document.createElement('div');
            btn.className = 'story-btn';
            btn.innerText = opt.text + " â¤";
            btn.onclick = () => {
                this.handleAction(opt.action);
            };
            optsEl.appendChild(btn);
        });
    },

    handleAction(action) {
        if (action === 'recruit_ghost') {
            const ghostData = JSON.parse(JSON.stringify(GameData.hiddenCharacters['ghost']));
            this.state.characters.push(ghostData);
            this.storyQueue.push({
                title: "æ‹›å‹ŸæˆåŠŸ",
                content: "è€é¬¼å·²åŠ å…¥é˜Ÿä¼ï¼ç‚¹å‡»å·¦ä¾§æ å¯æŸ¥çœ‹å±æ€§ã€‚",
                options: [{ text: "ç¡®å®š", action: "close" }]
            });
            this.renderAll();
        } else if (action === 'kill_ghost') {
            this.state.money += 200;
            this.storyQueue.push({
                title: "ä»»åŠ¡ç»“æŸ",
                content: "ä½ æ¶ˆç­äº†å¨èƒã€‚è·å¾—èµé‡‘ 200ã€‚",
                options: [{ text: "ç¡®å®š", action: "close" }]
            });
            this.renderAll();
        }
        this.playNextStory();
    },

    // --- äº¤äº’æ“ä½œ ---

    viewInventory() {
        this.selectedCharId = null;
        this.activeEventId = null;
        this.renderAll();
    },

    showItemDetails(itemName) {
        const def = GameData.itemDefinitions[itemName] || { slot: 'misc', bonus: 'æ— ', desc: 'æš‚æ— æè¿°' };
        const modal = document.getElementById('modal-wrapper');
        const list = document.getElementById('modal-content');
        
        modal.style.display = 'flex';
        
        // éƒ¨ä½åç§°æ˜ å°„
        const slotNames = { 'clothes': 'ğŸ‘” æœè£…', 'weapon': 'ğŸ”« æ­¦å™¨', 'accessory': 'ğŸ’ é¥°å“', 'misc': 'ğŸ“¦ æ‚ç‰©' };
        const slotName = slotNames[def.slot] || def.slot;

        list.innerHTML = `
            <h3 style="color:var(--accent-blue); border-bottom:1px solid #333; padding-bottom:10px;">${itemName}</h3>
            
            <div class="item-detail-label">ç‰©å“æè¿°</div>
            <div class="item-detail-val" style="line-height:1.6; color:#ccc;">${def.desc || "æš‚æ— æè¿°"}</div>
            
            <div style="display:flex; gap:20px; margin-top:20px; padding-top:10px; border-top:1px dashed #333">
                <div>
                    <div class="item-detail-label">è£…å¤‡éƒ¨ä½</div>
                    <div class="item-detail-val">${slotName}</div>
                </div>
                <div>
                    <div class="item-detail-label">å±æ€§åŠ æˆ</div>
                    <div class="item-detail-val" style="color:var(--accent-gold); font-weight:bold;">${def.bonus}</div>
                </div>
            </div>

            <div class="sidebar-btn" style="margin-top:20px;" onclick="document.getElementById('modal-wrapper').style.display='none'">å…³é—­</div>
        `;
    },

    selectChar(charId) {
        this.selectedCharId = charId;
        this.activeEventId = null; 
        this.renderAll();
    },

    selectEvent(eventId) {
        this.activeEventId = eventId;
        if (!this.assignments[eventId]) {
            this.assignments[eventId] = { charId: null, itemId: null };
        }
        this.renderAll();
    },

    assignCharToActiveEvent() {
        if (!this.activeEventId) return;
        
        const modal = document.getElementById('modal-wrapper');
        const list = document.getElementById('modal-content');
        modal.style.display = 'flex';
        list.innerHTML = '<h3>é€‰æ‹©æ‰§è¡Œå¹²å‘˜</h3>';

        this.state.characters.forEach(char => {
            let isBusy = false;
            for (let eid in this.assignments) {
                if (eid !== this.activeEventId && this.assignments[eid].charId === char.id) isBusy = true;
            }

            const btn = document.createElement('div');
            btn.className = 'inv-item';
            btn.style.color = isBusy ? '#555' : '#fff';
            btn.innerText = char.name + (isBusy ? " (å¿™ç¢Œ)" : "");
            
            if (!isBusy) {
                btn.onclick = () => {
                    this.assignments[this.activeEventId].charId = char.id;
                    modal.style.display = 'none';
                    this.renderAll();
                };
            }
            list.appendChild(btn);
        });
        
        const cancelBtn = document.createElement('div');
        cancelBtn.className = 'inv-item';
        cancelBtn.style.color = '#ff4a4a';
        cancelBtn.innerText = "[æ’¤å›äººå‘˜]";
        cancelBtn.onclick = () => {
            this.assignments[this.activeEventId].charId = null;
            modal.style.display = 'none';
            this.renderAll();
        }
        list.appendChild(cancelBtn);
    },

    assignItemToActiveEvent() {
        if (!this.activeEventId) return;

        const modal = document.getElementById('modal-wrapper');
        const list = document.getElementById('modal-content');
        modal.style.display = 'flex';
        list.innerHTML = '<h3>æºå¸¦ç‰¹æ®Šç‰©å“ (å¯é€‰)</h3>';

        this.state.inventory.forEach(item => {
            const btn = document.createElement('div');
            btn.className = 'inv-item';
            btn.innerText = item;
            btn.onclick = () => {
                this.assignments[this.activeEventId].itemId = item;
                modal.style.display = 'none';
                this.renderAll();
            };
            list.appendChild(btn);
        });

        const noneBtn = document.createElement('div');
        noneBtn.className = 'inv-item';
        noneBtn.style.color = '#aaa';
        noneBtn.innerText = "[ä¸æºå¸¦é¢å¤–ç‰©å“]";
        noneBtn.onclick = () => {
            this.assignments[this.activeEventId].itemId = null;
            modal.style.display = 'none';
            this.renderAll();
        }
        list.appendChild(noneBtn);
    },

    toggleEquip(slotName) {
        if (!this.selectedCharId) return;
        const char = this.state.characters.find(c => c.id === this.selectedCharId);
        const currentItem = char.equipment[slotName];

        const modal = document.getElementById('modal-wrapper');
        const list = document.getElementById('modal-content');
        modal.style.display = 'flex';
        list.innerHTML = `<h3>æ›´æ¢ ${slotName}</h3>`;

        if (currentItem) {
            const unequipBtn = document.createElement('div');
            unequipBtn.className = 'inv-item';
            unequipBtn.innerText = `[å¸ä¸‹] ${currentItem}`;
            unequipBtn.style.color = '#ff4a4a';
            unequipBtn.onclick = () => {
                this.state.inventory.push(currentItem);
                char.equipment[slotName] = null;
                this.renderAll();
                modal.style.display = 'none';
            };
            list.appendChild(unequipBtn);
        }

        this.state.inventory.forEach((item, idx) => {
            const def = GameData.itemDefinitions[item] || { slot: 'misc' };
            if (def.slot === slotName) {
                const btn = document.createElement('div');
                btn.className = 'inv-item';
                btn.innerText = item + ` (${def.bonus})`;
                btn.onclick = () => {
                    if (char.equipment[slotName]) this.state.inventory.push(char.equipment[slotName]);
                    char.equipment[slotName] = item;
                    this.state.inventory.splice(idx, 1);
                    this.renderAll();
                    modal.style.display = 'none';
                };
                list.appendChild(btn);
            }
        });
        
        // å¦‚æœä»“åº“æ²¡æœ‰è¯¥éƒ¨ä½çš„è£…å¤‡ï¼Œæç¤ºä¸€ä¸‹
        const hasItem = this.state.inventory.some(item => {
            const def = GameData.itemDefinitions[item] || { slot: 'misc' };
            return def.slot === slotName;
        });
        if(!hasItem && !currentItem) {
             const tip = document.createElement('div');
             tip.style.padding = '10px';
             tip.style.color = '#666';
             tip.innerText = "ä»“åº“é‡Œæ²¡æœ‰å¯ç”¨çš„è£…å¤‡ã€‚";
             list.appendChild(tip);
        }
    },

    renderAll() {
        document.getElementById('day-val').innerText = this.state.day;
        document.getElementById('money-val').innerText = this.state.money;
        this.renderSidebarLeft();
        this.renderEvents();
        this.renderSidebarRight();
    },

    renderSidebarLeft() {
        const container = document.getElementById('char-list');
        container.innerHTML = '';
        
        this.state.characters.forEach(char => {
            let isBusy = false;
            let busyEventTitle = '';
            for(let eid in this.assignments) {
                if(this.assignments[eid].charId === char.id) {
                    isBusy = true;
                    const evt = this.activeEvents.find(e=>e.id===eid);
                    if(evt) busyEventTitle = evt.title;
                }
            }

            const div = document.createElement('div');
            div.className = `char-card ${this.selectedCharId === char.id ? 'selected' : ''} ${isBusy ? 'busy' : ''}`;
            div.onclick = () => this.selectChar(char.id);
            
            let bonusStr = 0, bonusInt = 0;
            Object.values(char.equipment).forEach(item => {
                if(!item) return;
                const def = GameData.itemDefinitions[item];
                if(def && def.bonus) {
                    if(def.bonus.includes('åŠ›')) bonusStr += parseInt(def.bonus.split('+')[1]||0);
                    if(def.bonus.includes('æ™º')) bonusInt += parseInt(def.bonus.split('+')[1]||0);
                }
            });

            div.innerHTML = `
                <div class="char-name">
                    ${char.name} 
                    <span class="stat-badge">${char.role}</span>
                </div>
                <div class="char-status">${isBusy ? 'â¤ ' + busyEventTitle : 'å¾…å‘½'}</div>
                <div class="char-stats-row">
                    <span style="${bonusInt>0?'color:#4a9eff':''}">æ™º:${char.stats.int + bonusInt}</span>
                    <span style="${bonusStr>0?'color:#4a9eff':''}">åŠ›:${char.stats.str + bonusStr}</span>
                    <span>åŠ¿:${char.stats.sta}</span>
                </div>
            `;
            container.appendChild(div);
        });
    },

    renderEvents() {
        const container = document.getElementById('event-container');
        container.innerHTML = '';
        this.activeEvents.forEach(e => {
            const div = document.createElement('div');
            const assignment = this.assignments[e.id];
            const hasChar = assignment && assignment.charId;
            
            const isActive = this.activeEventId === e.id;
            const isConfigured = hasChar;

            div.className = `event-card ${isActive ? 'active' : ''} ${isConfigured ? 'configured' : ''}`;
            div.onclick = () => this.selectEvent(e.id);
            
            let assigneeName = '';
            if (hasChar) {
                const c = this.state.characters.find(char => char.id === assignment.charId);
                assigneeName = c ? c.name : 'æœªçŸ¥';
            }
            
            let ttlHtml = e.ttl !== undefined ? `<div class="event-ttl">â³ å‰© ${e.ttl} å¤©</div>` : '';
            
            div.innerHTML = `
                ${ttlHtml}
                <div style="font-size:0.8em; color:#666; text-transform:uppercase">${e.type}</div>
                <div class="event-title">${e.title}</div>
                <div class="event-desc">${e.desc}</div>
                ${hasChar ? `<div class="event-assignee">â¤ å·²æŒ‡æ´¾: ${assigneeName}</div>` : ''}
            `;
            container.appendChild(div);
        });
    },

    renderSidebarRight() {
        const container = document.getElementById('right-panel-content');
        container.innerHTML = '';

        // æ¨¡å¼ Aï¼šä»»åŠ¡æŒ‡æ´¾æ¨¡å¼
        if (this.activeEventId) {
            const event = this.activeEvents.find(e => e.id === this.activeEventId);
            if (!event) return;
            const assignment = this.assignments[this.activeEventId] || { charId: null, itemId: null };
            
            container.innerHTML = `<div class="panel-header">æŒ‡æ´¾ä»»åŠ¡: ${event.title}</div>`;
            
            const charSlot = document.createElement('div');
            charSlot.className = 'mission-slot';
            charSlot.onclick = () => this.assignCharToActiveEvent();
            const charName = assignment.charId ? this.state.characters.find(c => c.id === assignment.charId).name : 'ç‚¹å‡»é€‰æ‹©äººå‘˜';
            charSlot.innerHTML = `<span class="slot-title">æ‰§è¡Œå¹²å‘˜</span><span class="${assignment.charId?'slot-content':'slot-empty'}">${charName}</span>`;
            container.appendChild(charSlot);

            const itemSlot = document.createElement('div');
            itemSlot.className = 'mission-slot';
            itemSlot.onclick = () => this.assignItemToActiveEvent();
            const itemName = assignment.itemId ? assignment.itemId : 'ç‚¹å‡»é€‰æ‹©ç‰©å“';
            itemSlot.innerHTML = `<span class="slot-title">æºå¸¦ç‰©å“ (å¯é€‰)</span><span class="${assignment.itemId?'slot-content inv-special':'slot-empty'}">${itemName}</span>`;
            container.appendChild(itemSlot);

            const tip = document.createElement('div');
            tip.style.color = '#666'; tip.style.fontSize='0.9em';
            tip.innerText = "æç¤ºï¼šæŒ‡æ´¾å®Œæˆåï¼Œè¯¥äººå‘˜çŠ¶æ€å°†å˜ä¸ºå¿™ç¢Œã€‚";
            container.appendChild(tip);
            return;
        }

        // æ¨¡å¼ Bï¼šè£…å¤‡ç®¡ç†æ¨¡å¼
        if (this.selectedCharId) {
            const char = this.state.characters.find(c => c.id === this.selectedCharId);
            if(!char) return;

            container.innerHTML = `<div class="panel-header">é…ç½®è£…å¤‡: ${char.name}</div>`;
            const slots = [
                { key: 'clothes', label: 'ğŸ‘” æœè£…' },
                { key: 'weapon', label: 'ğŸ”« æ­¦å™¨' },
                { key: 'accessory', label: 'ğŸ’ é¥°å“' }
            ];

            slots.forEach(slot => {
                const div = document.createElement('div');
                div.className = 'equip-slot';
                div.onclick = () => this.toggleEquip(slot.key);
                const item = char.equipment[slot.key];
                const def = item ? (GameData.itemDefinitions[item] || {}) : {};
                div.innerHTML = `<span class="slot-label">${slot.label}</span><span class="slot-val" style="${item?'':'color:#444;font-weight:normal'}">${item ? item + (def.bonus?` (${def.bonus})`:'') : 'ç©º'}</span>`;
                container.appendChild(div);
            });
            return;
        }

        // æ¨¡å¼ Cï¼šæŸ¥çœ‹ä»“åº“æ¨¡å¼
        container.innerHTML = `<div class="panel-header">å…¬å…±ä»“åº“ (ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…)</div>`;
        this.state.inventory.forEach(item => {
            const row = document.createElement('div');
            row.className = 'inv-item';
            row.innerText = item;
            row.onclick = () => this.showItemDetails(item); // ç»‘å®šç‚¹å‡»äº‹ä»¶
            container.appendChild(row);
        });
    }
};

Game.init();
</script>
</body>
</html>
